<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Override PDF.js default styles */
        .page {
            position: relative;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            background: white;
        }
        
        .page canvas {
            display: block;
        }
        
        /* Text layer styling */
        .textLayer {
            opacity: 0.2;
        }
        
        .textLayer ::selection {
            background: rgba(0, 123, 255, 0.3);
        }
        
        /* Search highlights - using PDF.js classes */
        .textLayer .highlight {
            background-color: rgba(255, 237, 0, 0.4);
            border-radius: 2px;
        }
        
        .textLayer .highlight.selected {
            background-color: rgba(255, 140, 0, 0.6);
        }
        
        #viewerContainer {
            position: absolute;
            overflow: auto;
            width: 100%;
            top: 80px;
            bottom: 0;
        }
        
        #viewer {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 1rem;
        }
        
        #search-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            background: white;
            padding: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="search-bar">
        <div class="container mx-auto flex gap-2 items-center">
            <input 
                type="text" 
                id="search-input" 
                placeholder="Search in PDF..." 
                class="flex-1 border rounded px-3 py-2"
            />
            <button 
                id="prev-match" 
                class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 disabled:bg-gray-300"
                disabled
            >
                ← Previous
            </button>
            <button 
                id="next-match" 
                class="bg-blue-500 text-white px-3 py-2 rounded hover:bg-blue-600 disabled:bg-gray-300"
                disabled
            >
                Next →
            </button>
            <span id="match-counter" class="text-sm text-gray-600 min-w-[100px]"></span>
            <select id="zoom-select" class="border rounded px-2 py-1 text-sm">
                <option value="0.5">50%</option>
                <option value="0.75">75%</option>
                <option value="1">100%</option>
                <option value="1.5" selected>150%</option>
                <option value="2">200%</option>
            </select>
        </div>
    </div>

    <div id="viewerContainer">
        <div id="loading" class="text-center py-8">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-gray-900"></div>
            <p class="mt-4 text-gray-600">Loading PDF...</p>
        </div>
        <div id="viewer" class="pdfViewer"></div>
    </div>

    <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 
        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

    // Initialize EventBus for coordinating viewer components
    const eventBus = new pdfjsViewer.EventBus();
    
    // Create link service for navigation
    const pdfLinkService = new pdfjsViewer.PDFLinkService({
        eventBus: eventBus,
    });

    // Create PDF viewer
    const pdfViewer = new pdfjsViewer.PDFViewer({
        container: document.getElementById('viewerContainer'),
        viewer: document.getElementById('viewer'),
        eventBus: eventBus,
        linkService: pdfLinkService,
        textLayerMode: 1, // 0=disable, 1=enable, 2=enable enhanced
        removePageBorders: false,
    });

    pdfLinkService.setViewer(pdfViewer);
    
    console.log('PDFViewer initialized with textLayerMode:', pdfViewer.textLayerMode);

    // UI elements
    const searchInput = document.getElementById('search-input');
    const prevButton = document.getElementById('prev-match');
    const nextButton = document.getElementById('next-match');
    const matchCounter = document.getElementById('match-counter');
    const zoomSelect = document.getElementById('zoom-select');
    const loading = document.getElementById('loading');

    let currentMatchIndex = 0;
    let totalMatches = 0;
    let pdfFindController = null;
    let pagesReady = 0;

    // Load PDF
    async function loadPDF() {
        try {

            // Create find controller after document is loaded
            pdfFindController = new pdfjsViewer.PDFFindController({
                eventBus: eventBus,
                linkService: pdfLinkService,
                pdfViewer: pdfViewer,
            });

            // Set the find controller on the viewer BEFORE loading
            pdfViewer.findController = pdfFindController;

            const loadingTask = pdfjsLib.getDocument('/api/pdf');
            const pdfDocument = await loadingTask.promise;
            
            pdfViewer.setDocument(pdfDocument);
            pdfLinkService.setDocument(pdfDocument);
            pdfFindController.setDocument(pdfDocument);

            
            loading.style.display = 'none';
            
            // Set initial scale
            pdfViewer.currentScaleValue = '1.5';
            
            console.log('PDF loaded, total pages:', pdfDocument.numPages);
        } catch (error) {
            console.error('Error loading PDF:', error);
            loading.innerHTML = '<p class="text-red-600">Error loading PDF</p>';
        }
    }

    // Search functionality
    let searchTimeout = null;
    
    searchInput.addEventListener('input', (e) => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const query = e.target.value.trim();
            
            if (!query) {
                // Clear search
                if (pdfFindController) {
                    eventBus.dispatch('findbarclose');
                }
                updateMatchCounter(0, 0);
                return;
            }

            // Wait a bit more for text layers to be ready
            if (pagesReady < 1) {
                console.log('Waiting for pages to render...');
                setTimeout(() => {
                    performSearch(query);
                }, 500);
            } else {
                performSearch(query);
            }
        }, 300); // Debounce search
    });
    
    function performSearch(query) {
        console.log('Searching for:', query, 'Pages ready:', pagesReady);
        eventBus.dispatch('find', {
            type: 'find',
            query: query,
            caseSensitive: false,
            entireWord: false,
            highlightAll: true,
            findPrevious: false,
        });
    }

    // Listen for search results
    eventBus.on('updatefindmatchescount', (e) => {
        console.log('Match count update:', e);
        if (e.matchesCount) {
            totalMatches = e.matchesCount.total || 0;
            currentMatchIndex = e.matchesCount.current || 0;
            updateMatchCounter(currentMatchIndex, totalMatches);
        }
    });

    eventBus.on('updatefindcontrolstate', (e) => {
        console.log('Find control state:', e);
        if (e.state === pdfjsViewer.FindState.FOUND) {
            if (e.matchesCount) {
                currentMatchIndex = e.matchesCount.current || 0;
                totalMatches = e.matchesCount.total || 0;
                updateMatchCounter(currentMatchIndex, totalMatches);
            }
        } else if (e.state === pdfjsViewer.FindState.NOT_FOUND) {
            updateMatchCounter(0, 0);
        }
    });

    function updateMatchCounter(current, total) {
        if (total === 0) {
            matchCounter.textContent = searchInput.value.trim() ? 'No matches' : '';
            prevButton.disabled = true;
            nextButton.disabled = true;
        } else {
            matchCounter.textContent = `${current} / ${total}`;
            prevButton.disabled = false;
            nextButton.disabled = false;
        }
    }

    // Navigation buttons
    prevButton.addEventListener('click', () => {
        if (totalMatches === 0 || !pdfFindController) return;
        
        eventBus.dispatch('find', {
            type: 'again',
            query: searchInput.value.trim(),
            caseSensitive: false,
            entireWord: false,
            highlightAll: true,
            findPrevious: true,
        });
    });

    nextButton.addEventListener('click', () => {
        if (totalMatches === 0 || !pdfFindController) return;
        
        eventBus.dispatch('find', {
            type: 'again',
            query: searchInput.value.trim(),
            caseSensitive: false,
            entireWord: false,
            highlightAll: true,
            findPrevious: false,
        });
    });

    // Keyboard shortcuts
    searchInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            if (e.shiftKey) {
                prevButton.click();
            } else {
                nextButton.click();
            }
        } else if (e.key === 'Escape') {
            searchInput.value = '';
            eventBus.dispatch('findbarclose');
            updateMatchCounter(0, 0);
        }
    });

    // Zoom control
    zoomSelect.addEventListener('change', (e) => {
        pdfViewer.currentScaleValue = e.target.value;
        
        // Re-run search if active
        if (pdfFindController && searchInput.value.trim()) {
            setTimeout(() => {
                eventBus.dispatch('find', {
                    type: 'find',
                    query: searchInput.value.trim(),
                    caseSensitive: false,
                    entireWord: false,
                    highlightAll: true,
                    findPrevious: false,
                });
            }, 100);
        }
    });

    // Handle pages being rendered
    eventBus.on('pagerendered', (e) => {
        console.log(`Page ${Number(e.pageNumber)} rendered`);
        pagesReady++;
    });
    
    // Handle text layer rendered
    eventBus.on('textlayerrendered', (e) => {
        console.log(`Text layer ${Number(e.pageNumber)} rendered`);
    });

    // Load the PDF on page load
    loadPDF();
    </script>
</body>
</html>
