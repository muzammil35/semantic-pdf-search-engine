<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf_viewer.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/static/webapp/styles.css">
    <link rel="shortcut icon" href="/static/favicon/favicon.ico" />
</head>
<body>

    <!-- ── Upload Section ─────────────────────────────────────────────────── -->
    <div id="uploadSection" class="upload-container">
        <div class="upload-card">
            <h1>PDF Viewer</h1>
            <p class="subtitle">Select a document to view and search</p>
            <form id="uploadForm">
                <div class="file-drop-zone" id="dropZone">
                    <input type="file" id="pdfFile" name="pdf" accept=".pdf" required>
                    <svg class="icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 0 0 5.25 21h13.5A2.25 2.25 0 0 0 21 18.75V16.5m-13.5-9L12 3m0 0 4.5 4.5M12 3v13.5" />
                    </svg>
                    <p class="label">Click to browse or drag a file here</p>
                    <p class="hint">PDF files only</p>
                </div>
                <div class="file-name-display" id="fileNameDisplay">
                    <svg class="file-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                    </svg>
                    <span id="fileNameText"></span>
                </div>
                <button type="submit" class="btn-primary" id="uploadBtn">Open PDF</button>
            </form>
            <div id="uploadStatus" class="hidden" style="text-align:center; margin-top:1.25rem;">
                <div class="spinner"></div>
                <p class="upload-status-text">Loading PDF...</p>
            </div>
        </div>
    </div>

    <!-- ── Viewer Section (hidden initially) ─────────────────────────────── -->
    <div id="viewerSection" class="hidden">
        <div id="search-bar">
            <div class="search-bar-inner">
                <button id="back-to-upload" class="btn-back">&#8592; New PDF</button>
                <div class="search-input-wrapper">
                    <input
                        type="text"
                        id="search-input"
                        placeholder="Search in PDF..."
                        class="search-input"
                    />
                </div>
                <button id="prev-match" class="btn-search" disabled>&#8592; Prev</button>
                <button id="next-match" class="btn-search" disabled>Next &#8594;</button>
                <span id="match-counter" class="match-counter"></span>
                <select id="zoom-select" class="zoom-select">
                    <option value="0.5">50%</option>
                    <option value="0.75">75%</option>
                    <option value="1" selected>100%</option>
                    <option value="1.5">150%</option>
                    <option value="2">200%</option>
                </select>
            </div>
        </div>

        <div id="viewerContainer">
            <div id="loading" class="viewer-loading">
                <div class="spinner"></div>
                <p>Loading PDF...</p>
            </div>
            <div id="viewer" class="pdfViewer"></div>
        </div>
    </div>

    <!-- ── Main app logic ─────────────────────────────────────────────────── -->
    <script type="module">
        import {
            initDropZone,
            initializeViewer,
            loadPDF,
            clearAllHighlights,
            scrollToMatch,
            updateMatchCounter,
            getBackendResults,
            waitUntilReady,
        } from '/static/utils.js';

        pdfjsLib.GlobalWorkerOptions.workerSrc =
            'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // ── DOM refs ──────────────────────────────────────────────────────
        const uploadSection  = document.getElementById('uploadSection');
        const viewerSection  = document.getElementById('viewerSection');
        const uploadForm     = document.getElementById('uploadForm');
        const uploadStatus   = document.getElementById('uploadStatus');
        const fileNameDisplay = document.getElementById('fileNameDisplay');
        const backButton     = document.getElementById('back-to-upload');
        const searchInput    = document.getElementById('search-input');
        const prevButton     = document.getElementById('prev-match');
        const nextButton     = document.getElementById('next-match');
        const matchCounter   = document.getElementById('match-counter');
        const zoomSelect     = document.getElementById('zoom-select');

        // ── Viewer state ──────────────────────────────────────────────────
        let pdfData           = null;
        let pdfLinkService    = null;
        let pdfViewer         = null;
        let documentId        = null;
        let currentMatchIndex = 0;
        let matchResults      = [];
        let activeHighlights  = [];

        // ── Init drop zone ────────────────────────────────────────────────
        initDropZone();

        // ── Upload ────────────────────────────────────────────────────────
        uploadForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = document.getElementById('pdfFile').files[0];
            if (!file) { alert('Please select a PDF file'); return; }

            uploadStatus.classList.remove('hidden');
            const formData = new FormData();
            formData.append('pdf', file);

            try {
                const response = await fetch('/upload', { method: 'POST', body: formData });
                if (!response.ok) throw new Error('Upload failed');
                const responseData = await response.json();
                documentId = responseData.id;
                pdfData = await file.arrayBuffer();

                uploadSection.classList.add('hidden');
                viewerSection.classList.remove('hidden');
                uploadStatus.classList.add('hidden');

                ({ pdfLinkService, pdfViewer } = initializeViewer());
                await loadPDF(pdfData, pdfViewer, pdfLinkService);
                // Disable search while indexing
                searchInput.disabled = true;
                searchInput.placeholder = 'Embedding PDF, please wait...';

                // Create spinner element
                const spinner = document.createElement('div');
                spinner.classList.add('spinner');

                // Append spinner to the parent wrapper (.search-bar-inner)
                searchInput.parentNode.appendChild(spinner);

                // Poll until backend is ready
                await waitUntilReady(documentId);

                spinner.remove();
                searchInput.disabled = false;
                searchInput.placeholder = 'Search in PDF...';
            } catch (error) {
                console.error('Error:', error);
                alert('Failed to upload PDF: ' + error.message);
                uploadStatus.classList.add('hidden');
            }
        });

        // ── Back button ───────────────────────────────────────────────────
        backButton.addEventListener('click', () => {
            if (pdfViewer) {
                try { pdfViewer.setDocument(null); } catch (_) {}
                pdfViewer      = null;
                pdfLinkService = null;
            }
            pdfData           = null;
            documentId        = null;
            matchResults      = [];
            currentMatchIndex = 0;
            activeHighlights  = [];

            document.getElementById('viewer').innerHTML = '';
            searchInput.value = '';
            updateMatchCounter(matchResults, currentMatchIndex, searchInput, prevButton, nextButton, matchCounter);
            uploadForm.reset();
            fileNameDisplay.classList.remove('visible');
            viewerSection.classList.add('hidden');
            uploadSection.classList.remove('hidden');
        });

        // ── Search ────────────────────────────────────────────────────────
        let searchTimeout = null;
        let searchAbortController = null; // 

        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);

            // Cancel any in-flight request immediately
            if (searchAbortController) {
                searchAbortController.abort();
                searchAbortController = null;
            }

            searchTimeout = setTimeout(async () => {
                const query = e.target.value.trim();
                if (!query) {
                    clearAllHighlights();
                    activeHighlights  = [];
                    matchResults      = [];
                    updateMatchCounter(matchResults, currentMatchIndex, searchInput, prevButton, nextButton, matchCounter);
                    return;
                }

                // Create a new controller for this request
                searchAbortController = new AbortController();

                try {
                    const results = await getBackendResults(query, documentId, searchAbortController.signal); 
                    searchAbortController = null;

                    if (!results || results.length === 0) {
                        clearAllHighlights();
                        updateMatchCounter(matchResults, currentMatchIndex, searchInput, prevButton, nextButton, matchCounter);
                        return;
                    }

                    console.log('results for this query:', query, results);

                    matchResults      = results;
                    currentMatchIndex = 0;
                    activeHighlights  = results;

                    scrollToMatch(0, activeHighlights, pdfViewer);
                    updateMatchCounter(matchResults, currentMatchIndex, searchInput, prevButton, nextButton, matchCounter);
                } catch (error) {
                    if (error.name === 'AbortError') {
                        console.log('Search request cancelled:', query);
                        return; // Silently ignore — a newer request is already in flight
                    }
                    console.error('Search error:', error);
                }
            }, 300);
        });

        // ── Navigation ────────────────────────────────────────────────────
        prevButton.addEventListener('click', () => {
            if (!matchResults.length || currentMatchIndex === 0) return;
            currentMatchIndex--;
            scrollToMatch(currentMatchIndex, activeHighlights, pdfViewer);
            updateMatchCounter(matchResults, currentMatchIndex, searchInput, prevButton, nextButton, matchCounter);
        });

        nextButton.addEventListener('click', () => {
            if (!matchResults.length || currentMatchIndex >= matchResults.length - 1) return;
            currentMatchIndex++;
            scrollToMatch(currentMatchIndex, activeHighlights, pdfViewer);
            updateMatchCounter(matchResults, currentMatchIndex, searchInput, prevButton, nextButton, matchCounter);
        });

        // ── Zoom ──────────────────────────────────────────────────────────
        zoomSelect.addEventListener('change', (e) => {
            pdfViewer.currentScaleValue = e.target.value;
        });
    </script>

</body>
</html>
